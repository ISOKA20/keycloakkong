_format_version: "3.0"

services:
  - name: dotnet-auth
    url: http://host.docker.internal:5152
    routes:
      - name: auth-route
        paths:
          - /auth
        strip_path: false

  - name: httpbin
    url: http://httpbin:80
    routes:
      - name: api
        paths:
          - /api
        strip_path: true
        plugins:
          # 1. Tu plugin: Extrae el token de Redis y lo pone en el Header Authorization
          - name: extract-session
            config:
              redis_host: redis
          
          # 2. Plugin JWT: Valida el token que puso tu plugin en el header
          - name: jwt
            config:
              key_claim_name: iss
              claims_to_verify:
                - exp
              run_on_preflight: false

# Consumidor que vincula la llave p√∫blica de Keycloak con el "iss" del token
consumers:
  - username: master-realm
    jwt_secrets:
      - key: http://localhost:8080/realms/master
        algorithm: RS256
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwB1UYx8QISbvycCzuBFz
          Weavoqf96ZFX4LqJTGoLLGeqkm/waPC+FZYNpXeudO8wObFWnNHO2DzyCHLGIMF7
          Dpb/NjEDpWc4UVzXcU9Tyn9f11m13EVSD8xoiD686inQ3XWSLlajPVgB6t96RWFp
          Ctv0sfoWxAESezvj0caGAajNnr6QznhbuLJuVZvXZs/7xoIgEyOAQBboHjneUNAE
          i/8cL5uvPsGyoZLvPGYcMuqZYXFZ3Com2ndJ418r9vsIGmQCtIpubR03cS5GxeKE
          Kg4eeLafEqVBldaOAT8RY/G81FH+ItV+Vku3rETuAoBNnu+mPGvn1RKftgRwKo1T
          kwIDAQAB
          -----END PUBLIC KEY-----

plugins:
  - name: cors
    config:
      origins:
        - http://localhost:4200
      methods:
        - GET
        - POST
        - OPTIONS
      credentials: true
      headers:
        - Accept
        - Content-Type
        - Authorization
        - Cookie
      exposed_headers:
        - Set-Cookie